# ===================================================================
# ë²”ìš© CI/CD ë°°í¬ ì›Œí¬í”Œë¡œìš°
# ===================================================================

name: CICD-HOME-SERVER

# ===================================================================
# íŠ¸ë¦¬ê±° ì„¤ì •
# ===================================================================
on:
  push:
    branches:
      # NOTE: ì‚¬ìš© í•  ë¸Œëžœì¹˜ë§Œ ë¹¼ê³  ì£¼ì„ì²˜ë¦¬
      - main     # í”„ë¡œë•ì…˜ ë°°í¬
      - release  # í”„ë¡œë•ì…˜ ë°°í¬
      - develop  # ê°œë°œ í™˜ê²½ ë°°í¬
      - test     # í…ŒìŠ¤íŠ¸ í™˜ê²½ ë°°í¬
  workflow_dispatch:   # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

permissions:
  contents: read

# ===================================================================
# ë™ì‹œ ë°°í¬ ë°©ì§€
# ===================================================================
concurrency:
  group: deploy-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  # ===================================================================
  # ë¹Œë“œ ìž‘ì—…
  # ===================================================================
  build:
    name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: deploy.env íŒŒì¼ ìƒì„±
        run: echo "${{ secrets.DEPLOY_ENV }}" > .github/config/deploy.env

      - name: ë¹Œë“œ ì„¤ì • ë¡œë“œ
        id: config
        run: |
          echo "âš™ï¸ deploy.env íŒŒì¼ì—ì„œ ë¹Œë“œ ì„¤ì •ì„ ë¡œë“œí•©ë‹ˆë‹¤..."
          while IFS='=' read -r key value; do
            if [[ ! $key =~ ^#.*$ ]] && [[ -n $key ]] && [[ ! $key =~ ^[[:space:]]*$ ]]; then
              key=$(echo "$key" | xargs)
              value=$(echo "$value" | xargs)
              echo "::add-mask::${value}"
              echo "${key}=${value}" >> $GITHUB_OUTPUT
            fi
          done < .github/config/deploy.env

          # í•„ìˆ˜ ì„¤ì •ê°’ ê²€ì¦
          source .github/config/deploy.env
          if [ -z "$PROJECT_NAME" ]; then echo "âŒ PROJECT_NAMEì´ ë¹„ì–´ ìžˆìŠµë‹ˆë‹¤."; exit 1; fi
          if [ -z "$PROJECT_BASE_PATH" ]; then echo "âŒ PROJECT_BASE_PATHê°€ ë¹„ì–´ ìžˆìŠµë‹ˆë‹¤."; exit 1; fi
          if [ -z "$PROJECT_FOLDER_NAME" ]; then echo "âŒ PROJECT_FOLDER_NAMEì´ ë¹„ì–´ ìžˆìŠµë‹ˆë‹¤."; exit 1; fi

          # DEPLOY_MODE ê¸°ë³¸ê°’ ì„¤ì •
          if [ -z "$DEPLOY_MODE" ]; then
            echo "DEPLOY_MODE=single" >> $GITHUB_OUTPUT
          fi

      - name: Docker ë¹Œë“œí™˜ê²½ ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: DockerHub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.ref_name }}-${{ hashFiles('Dockerfile', '**/requirements*.txt', '**/pyproject.toml', '**/package-lock.json', '**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ github.ref_name }}-
            ${{ runner.os }}-buildx-

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ steps.config.outputs.PROJECT_NAME }}:${{ github.ref_name }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Move Docker cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: ë¹Œë“œ ìž‘ì—… ì™„ë£Œ ë¡œê·¸
        run: echo "ðŸª„ ëª¨ë“  ë¹Œë“œ ìž‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."

  # ===================================================================
  # ë°°í¬ ìž‘ì—…
  # ===================================================================
  deploy:
    name: ì˜¨í”„ë ˆë¯¸ìŠ¤ ì„œë²„ ë°°í¬
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: deploy.env íŒŒì¼ ìƒì„±
        run: echo "${{ secrets.DEPLOY_ENV }}" > .github/config/deploy.env

      - name: ë°°í¬ ì„¤ì • ë¡œë“œ
        id: config
        run: |
          echo "ðŸ“„ deploy.env íŒŒì¼ì—ì„œ ì„¤ì •ì„ ë¡œë“œí•©ë‹ˆë‹¤..."
          while IFS='=' read -r key value; do
            if [[ ! $key =~ ^#.*$ ]] && [[ -n $key ]] && [[ ! $key =~ ^[[:space:]]*$ ]]; then
              key=$(echo "$key" | xargs)
              value=$(echo "$value" | xargs)
              echo "::add-mask::${value}"
              echo "${key}=${value}" >> $GITHUB_OUTPUT
            fi
          done < .github/config/deploy.env

          # DEPLOY_MODE ê¸°ë³¸ê°’ ì„¤ì •
          source .github/config/deploy.env
          if [ -z "$DEPLOY_MODE" ]; then
            echo "DEPLOY_MODE=single" >> $GITHUB_OUTPUT
          fi

      - name: Docker Compose íŒŒì¼ ì „ì†¡
        if: ${{ steps.config.outputs.DEPLOY_MODE == 'compose' }}
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "docker-compose.yml"
          target: "${{ steps.config.outputs.PROJECT_BASE_PATH }}/${{ steps.config.outputs.PROJECT_FOLDER_NAME }}"

      - name: Deploy
        uses: appleboy/ssh-action@v1.2.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT}}
          script: |
            set -e

            # ============================================================
            # ì„¤ì •ê°’ ë¡œë“œ
            # ============================================================
            echo "ðŸ”§ ë°°í¬ ì„¤ì • ë¡œë“œ ì¤‘..."
            BRANCH="${{ github.ref_name }}"
            PROJECT_NAME="${{ steps.config.outputs.PROJECT_NAME }}"
            PROJECT_BASE_PATH="${{ steps.config.outputs.PROJECT_BASE_PATH }}"
            PROJECT_FOLDER_NAME="${{ steps.config.outputs.PROJECT_FOLDER_NAME }}"
            PROJECT_SUB_PATH="${{ steps.config.outputs.PROJECT_SUB_PATH }}"
            CONTAINER_PORT="${{ steps.config.outputs.CONTAINER_PORT }}"
            PRODUCTION_PORT="${{ steps.config.outputs.PRODUCTION_PORT }}"
            DEVELOPMENT_PORT="${{ steps.config.outputs.DEVELOPMENT_PORT }}"
            TEST_PORT="${{ steps.config.outputs.TEST_PORT }}"

            # ============================================================
            # ê²½ë¡œ ìˆœíšŒ ê²€ì¦
            # ============================================================
            if echo "$PROJECT_SUB_PATH" | grep -q '\.\.'; then
              echo "âŒ PROJECT_SUB_PATHì— '..'ì´ í¬í•¨ë˜ì–´ ìžˆìŠµë‹ˆë‹¤. ê²½ë¡œ ìˆœíšŒ ê³µê²© ë°©ì§€ë¥¼ ìœ„í•´ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
              exit 1
            fi

            HOST_MOUNT_PATH="${PROJECT_BASE_PATH}/${PROJECT_FOLDER_NAME}/${PROJECT_SUB_PATH}"
            CONTAINER_MOUNT_PATH="/mnt/${PROJECT_FOLDER_NAME}"

            # ============================================================
            # í•„ìˆ˜ ì„¤ì •ê°’ ê²€ì¦
            # ============================================================
            if [ -z "$PROJECT_NAME" ]; then echo "âŒ PROJECT_NAMEì´ ë¹„ì–´ ìžˆìŠµë‹ˆë‹¤."; exit 1; fi
            if [ -z "$PROJECT_BASE_PATH" ]; then echo "âŒ PROJECT_BASE_PATHê°€ ë¹„ì–´ ìžˆìŠµë‹ˆë‹¤."; exit 1; fi
            if [ -z "$PROJECT_FOLDER_NAME" ]; then echo "âŒ PROJECT_FOLDER_NAMEì´ ë¹„ì–´ ìžˆìŠµë‹ˆë‹¤."; exit 1; fi

            # ============================================================
            # ë¸Œëžœì¹˜ë³„ í¬íŠ¸ ë° ì»¨í…Œì´ë„ˆëª… ì„¤ì •
            # ============================================================
            if [ "$BRANCH" == "main" ] || [ "$BRANCH" == "release" ]; then
              PORT="$PRODUCTION_PORT"
              CONTAINER_NAME="${PROJECT_NAME}"
              DEPLOY_ENV_NAME="Production"
              echo "ðŸŒ [Production] í™˜ê²½ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ."
            elif [ "$BRANCH" == "develop" ]; then
              PORT="$DEVELOPMENT_PORT"
              CONTAINER_NAME="${PROJECT_NAME}-dev"
              DEPLOY_ENV_NAME="Dev"
              echo "ðŸ’» [Dev] í™˜ê²½ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ."
            elif [ "$BRANCH" == "test" ]; then
              PORT="$TEST_PORT"
              CONTAINER_NAME="${PROJECT_NAME}-test"
              DEPLOY_ENV_NAME="Test"
              echo "ðŸ§ª [Test] í™˜ê²½ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ."
            else
              echo "âš ï¸ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œëžœì¹˜ìž…ë‹ˆë‹¤: $BRANCH"
              exit 1
            fi

            # ============================================================
            # ìµœì¢… ë°°í¬ ì„¤ì • ìš”ì•½
            # ============================================================
            DEPLOY_MODE="${{ steps.config.outputs.DEPLOY_MODE }}"
            DOCKER_IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:${BRANCH}"

            echo "--- ðŸ“‹ ìµœì¢… ë°°í¬ ì„¤ì • ì ìš© ì™„ë£Œ ---"
            echo "  - ë°°í¬ í™˜ê²½: ðŸ˜ï¸ ${DEPLOY_ENV_NAME}"
            echo "  - ëŒ€ìƒ ë¸Œëžœì¹˜: ðŸªµ ${BRANCH}"
            echo "  - ë°°í¬ ëª¨ë“œ: ðŸ“¦ ${DEPLOY_MODE}"
            echo "  - ì ìš©ëœ ì»¨í…Œì´ë„ˆ ì´ë¦„: ðŸ“¦ ${CONTAINER_NAME}"
            echo "------------------------------------"

            if [ "$DEPLOY_MODE" = "compose" ]; then
              # ============================================================
              # Compose ëª¨ë“œ ë°°í¬
              # ============================================================
              PROJECT_DIR="${PROJECT_BASE_PATH}/${PROJECT_FOLDER_NAME}"
              cd "$PROJECT_DIR"

              # .env íŒŒì¼ì— ë°°í¬ ë³€ìˆ˜ ì¶”ê°€ (compose ì¹˜í™˜ìš©)
              DEPLOY_VARS="DOCKER_IMAGE=${DOCKER_IMAGE}
            HOST_PORT=${PORT}
            CONTAINER_PORT=${CONTAINER_PORT:-8000}
            HOST_MOUNT_PATH=${HOST_MOUNT_PATH}
            CONTAINER_MOUNT_PATH=${CONTAINER_MOUNT_PATH}"

              umask 077
              if [ -n "${{ secrets.PROJECT_ENV }}" ]; then
                echo "${DEPLOY_VARS}" > .env
                echo "" >> .env
                echo "${{ secrets.PROJECT_ENV }}" >> .env
              else
                echo "${DEPLOY_VARS}" > .env
              fi

              # Docker Compose Pull & Deploy
              echo "â¬‡ï¸ Docker Compose ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤..."
              docker compose pull

              echo "âš ï¸ ê¸°ì¡´ ì„œë¹„ìŠ¤ë¥¼ ì •ìƒ ì¢…ë£Œí•©ë‹ˆë‹¤..."
              docker compose down --timeout 10 || true

              echo "ðŸš€ Docker Compose ì„œë¹„ìŠ¤ë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤..."
              docker compose up -d

              # Health Check
              echo "ðŸ¥ ì„œë¹„ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
              sleep 3
              for i in $(seq 1 10); do
                RUNNING=$(docker compose ps --status running --format json | wc -l)
                TOTAL=$(docker compose ps --format json | wc -l)
                if [ "$RUNNING" -eq "$TOTAL" ] && [ "$TOTAL" -gt 0 ]; then
                  echo "âœ… ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ìž…ë‹ˆë‹¤. ($RUNNING/$TOTAL)"
                  break
                fi
                if [ "$i" -eq 10 ]; then
                  echo "âŒ ì¼ë¶€ ì„œë¹„ìŠ¤ê°€ ì‹œìž‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ($RUNNING/$TOTAL)"
                  docker compose ps
                  docker compose logs --tail 20
                  exit 1
                fi
                sleep 2
              done

              docker image prune -f

              echo "ðŸ¥‚ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (Compose ëª¨ë“œ)"

            else
              # ============================================================
              # Single ëª¨ë“œ ë°°í¬ (ê¸°ì¡´ ë¡œì§)
              # ============================================================

              # ðŸ”‘ ì›ê²© ì„œë²„ì— .env íŒŒì¼ ìƒì„±
              ENV_FILE_OPTION=""
              if [ -n "${{ secrets.PROJECT_ENV }}" ]; then
                echo "ðŸ“ GitHub Secretsì— PROJECT_ENVê°€ ì¡´ìž¬í•©ë‹ˆë‹¤. ì›ê²© ì„œë²„ì— .env íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤..."
                umask 077
                echo "${{ secrets.PROJECT_ENV }}" > .env
                ENV_FILE_OPTION="yes"
                echo "âœ… .env íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
              else
                echo "â„¹ï¸ GitHub Secretsì— PROJECT_ENVê°€ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. .env íŒŒì¼ ìƒì„±ì„ ê±´ë„ˆëœë‹ˆë‹¤."
              fi

              # Docker ì´ë¯¸ì§€ í’€ (Pull)
              echo "â¬‡ï¸ ë°°í¬í•  Docker ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤..."
              docker pull "${DOCKER_IMAGE}"

              # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ Graceful Shutdown
              echo "ðŸ§¹ ê¸°ì¡´ ë°°í¬ ì»¨í…Œì´ë„ˆì˜ ì¡´ìž¬ ì—¬ë¶€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
              if docker ps -a --format '{{.Names}}' | grep -Eq "^${CONTAINER_NAME}$"; then
                echo "ðŸ“‹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ë¡œê·¸ë¥¼ ë°±ì—…í•©ë‹ˆë‹¤..."
                docker logs --tail 500 "$CONTAINER_NAME" > "${HOST_MOUNT_PATH}/container-$(date +%Y%m%d-%H%M%S).log" 2>&1 || true
                echo "âš ï¸ ê¸°ì¡´ ì»¨í…Œì´ë„ˆë¥¼ ì •ìƒ ì¢…ë£Œí•©ë‹ˆë‹¤..."
                docker stop --time 10 "$CONTAINER_NAME" || true
                docker rm "$CONTAINER_NAME" || true
                echo "âœ… ê¸°ì¡´ ì»¨í…Œì´ë„ˆê°€ ì„±ê³µì ìœ¼ë¡œ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."
              else
                echo "â„¹ï¸ ìƒˆë¡œ ë°°í¬í•  ì»¨í…Œì´ë„ˆì™€ ì´ë¦„ì´ ê°™ì€ ê¸°ì¡´ ì»¨í…Œì´ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤."
              fi

              # í˜¸ìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ ì¤€ë¹„
              echo "ðŸ“‚ ì»¨í…Œì´ë„ˆì— ì—°ê²°í•  í˜¸ìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì¤€ë¹„í•©ë‹ˆë‹¤..."
              mkdir -p "$HOST_MOUNT_PATH"

              # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
              echo "ðŸš€ ìƒˆë¡œìš´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
              docker run -d \
                --restart unless-stopped \
                --log-opt max-size=10m \
                --log-opt max-file=3 \
                --security-opt=no-new-privileges:true \
                --cap-drop=ALL \
                --pids-limit 512 \
                --memory 512m \
                -p "${PORT}:${CONTAINER_PORT:-8000}" \
                --name "$CONTAINER_NAME" \
                $([ "$ENV_FILE_OPTION" = "yes" ] && echo "--env-file .env") \
                -e TZ=Asia/Seoul \
                -v /etc/localtime:/etc/localtime:ro \
                -v "${HOST_MOUNT_PATH}:${CONTAINER_MOUNT_PATH}" \
                "${DOCKER_IMAGE}"
                # í•„ìš” ì‹œ ì•„ëž˜ ì˜µì…˜ì„ ì¶”ê°€í•˜ì„¸ìš”:
                # --read-only           # ì»¨í…Œì´ë„ˆ íŒŒì¼ì‹œìŠ¤í…œ ì½ê¸° ì „ìš© (tmpfs ë§ˆìš´íŠ¸ í•„ìš”í•  ìˆ˜ ìžˆìŒ)
                # --user 1000:1000      # non-root ì‚¬ìš©ìžë¡œ ì‹¤í–‰

              # Health Check
              echo "ðŸ¥ ì»¨í…Œì´ë„ˆ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
              sleep 3
              for i in $(seq 1 10); do
                if docker ps --format '{{.Names}}' | grep -Eq "^${CONTAINER_NAME}$"; then
                  echo "âœ… ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ìž…ë‹ˆë‹¤."
                  break
                fi
                if [ "$i" -eq 10 ]; then
                  echo "âŒ ì»¨í…Œì´ë„ˆê°€ ì‹œìž‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìµœê·¼ ë¡œê·¸:"
                  docker logs "$CONTAINER_NAME" 2>&1 | tail -20 || true
                  exit 1
                fi
                sleep 2
              done

              # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ì´ë¯¸ì§€ ì •ë¦¬
              echo "ðŸ§¹ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ì´ë¯¸ì§€ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤..."
              docker image prune -f

              echo "ðŸ¥‚ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
              echo "   - ì‹¤í–‰ëœ ì»¨í…Œì´ë„ˆ: ðŸ“¦ $CONTAINER_NAME"
            fi

      - name: ë°°í¬ ì•Œë¦¼ ì „ì†¡
        if: ${{ always() && secrets.DISCORD_WEBHOOK_URL != '' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            EMOJI="âœ…"
          else
            EMOJI="âŒ"
          fi
          curl -s -H "Content-Type: application/json" \
            -d "{\"content\": \"${EMOJI} **[${{ github.ref_name }}] ë°°í¬ ${STATUS}** - ${{ github.repository }} (${GITHUB_SHA::7})\"}" \
            "$DISCORD_WEBHOOK_URL" 2>/dev/null || true
