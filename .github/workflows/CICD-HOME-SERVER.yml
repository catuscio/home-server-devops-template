# ===================================================================
# 범용 CI/CD 배포 워크플로우
# ===================================================================

name: CICD-HOME-SERVER

# ===================================================================
# 트리거 설정
# ===================================================================
on:
  push:
    branches:
      # NOTE: 사용 할 브랜치만 빼고 주석처리
      - main     # 프로덕션 배포
      - release  # 프로덕션 배포
      - develop  # 개발 환경 배포
      - test     # 테스트 환경 배포
  workflow_dispatch:   # 수동 실행 허용

jobs:
  # ===================================================================
  # 빌드 작업
  # ===================================================================
  build:
    name: 애플리케이션 빌드
    runs-on: ubuntu-latest
    outputs:
      project_name: ${{ steps.config.outputs.PROJECT_NAME }}
      project_base_path: ${{ steps.config.outputs.PROJECT_BASE_PATH }}
      project_folder_name: ${{ steps.config.outputs.PROJECT_FOLDER_NAME }}
      project_sub_path: ${{ steps.config.outputs.PROJECT_SUB_PATH }}
      production_port: ${{ steps.config.outputs.PRODUCTION_PORT }}
      development_port: ${{ steps.config.outputs.DEVELOPMENT_PORT }}
      test_port: ${{ steps.config.outputs.TEST_PORT }}
     
    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: deploy.env 파일 생성
        run: echo "${{ secrets.DEPLOY_ENV }}" > .github/config/deploy.env

      - name: 빌드 설정 로드
        id: config
        run: |
          echo "⚙️ deploy.env 파일에서 빌드 설정을 로드합니다..."
          while IFS='=' read -r key value; do
            if [[ ! $key =~ ^#.*$ ]] && [[ -n $key ]] && [[ ! $key =~ ^[[:space:]]*$ ]]; then
              key=$(echo "$key" | xargs)
              value=$(echo "$value" | xargs)
              echo "${key}=${value}" >> $GITHUB_OUTPUT
            fi
          done < .github/config/deploy.env

      - name: Docker 빌드환경 설정
        uses: docker/setup-buildx-action@v3

      - name: DockerHub 로그인
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('Dockerfile') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Docker 이미지 빌드 및 푸시
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ steps.config.outputs.PROJECT_NAME }}:${{ github.ref_name }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Move Docker cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
      
      - name: 빌드 작업 완료 로그
        run: echo "🪄 모든 빌드 작업이 성공적으로 완료되었습니다."

  # ===================================================================
  # 배포 작업
  # ===================================================================
  deploy:
    name: 온프레미스 서버 배포
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT}}
          script: |
            set -e

            # ============================================================
            # 설정값 로드
            # ============================================================
            echo "🔧 배포 설정 로드 중..."
            BRANCH="${{ github.ref_name }}"
            PROJECT_NAME="${{ needs.build.outputs.project_name }}"
            PROJECT_BASE_PATH="${{ needs.build.outputs.project_base_path }}"
            PROJECT_FOLDER_NAME="${{ needs.build.outputs.project_folder_name }}"
            PROJECT_SUB_PATH="${{ needs.build.outputs.project_sub_path }}"
            PRODUCTION_PORT="${{ needs.build.outputs.production_port }}"
            DEVELOPMENT_PORT="${{ needs.build.outputs.development_port }}"
            TEST_PORT="${{ needs.build.outputs.test_port }}"
            HOST_MOUNT_PATH="${PROJECT_BASE_PATH}/${PROJECT_FOLDER_NAME}/${PROJECT_SUB_PATH}"
            CONTAINER_MOUNT_PATH="/mnt/${PROJECT_FOLDER_NAME}"

            # ============================================================
            # 브랜치별 포트 및 컨테이너명 설정
            # ============================================================
            if [ "$BRANCH" == "main" ] || [ "$BRANCH" == "release" ]; then
              PORT="$PRODUCTION_PORT"
              CONTAINER_NAME="${PROJECT_NAME}"
              DEPLOY_ENV_NAME="Production"
              echo "🌐 [Production] 환경 배포 준비 완료."
            elif [ "$BRANCH" == "develop" ]; then
              PORT="$DEVELOPMENT_PORT"
              CONTAINER_NAME="${PROJECT_NAME}-dev"
              DEPLOY_ENV_NAME="Dev"
              echo "💻 [Dev] 환경 배포 준비 완료."
            elif [ "$BRANCH" == "test" ]; then
              PORT="$TEST_PORT"
              CONTAINER_NAME="${PROJECT_NAME}-test"
              DEPLOY_ENV_NAME="Test"
              echo "🧪 [Test] 환경 배포 준비 완료."
            else
              echo "⚠️ 지원하지 않는 브랜치입니다: $BRANCH"
              exit 1
            fi

            # ============================================================
            # 최종 배포 설정 요약 (보안 강화 버전)
            # ============================================================
            echo "--- 📋 최종 배포 설정 적용 완료 ---"
            echo "  - 배포 환경: 🏘️ ${DEPLOY_ENV_NAME}"
            echo "  - 대상 브랜치: 🪵 ${BRANCH}"
            echo "  - 적용된 컨테이너 이름: 📦 ${CONTAINER_NAME}"
            echo "------------------------------------"

            # ============================================================
            # 🔑 원격 서버에 .env 파일 생성
            # ============================================================
            # Docker run 명령어에 추가할 --env-file 옵션을 저장할 변수
            ENV_FILE_OPTION=""
            
            # GitHub Secrets에 ENV가 존재하는지 확인
            if [ -n "${{ secrets.PROJECT_ENV }}" ]; then
              echo "📝 GitHub Secrets에 PROJECT_ENV가 존재합니다. 원격 서버에 .env 파일을 생성합니다..."
              echo "${{ secrets.PROJECT_ENV }}" > .env
              ENV_FILE_OPTION="--env-file .env" # 변수가 존재할 경우에만 옵션 추가
              echo "✅ .env 파일이 성공적으로 생성되었습니다."
            else
              echo "ℹ️ GitHub Secrets에 PROJECT_ENV가 존재하지 않습니다. .env 파일 생성을 건너뜁니다."
            fi

            # ============================================================
            # Docker 이미지 풀 (Pull)
            # ============================================================
            echo "⬇️ 배포할 Docker 이미지를 가져옵니다..."
            docker pull "${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:${BRANCH}"

            # ============================================================
            # 기존 컨테이너 정리
            # ============================================================
            echo "🧹 기존 배포 컨테이너의 존재 여부를 확인합니다..."
            if docker ps -a --format '{{.Names}}' | grep -Eq "^${CONTAINER_NAME}$"; then
              echo "⚠️ 이전에 배포된 컨테이너가 존재하여 중지 및 삭제를 진행합니다."
              docker rm -f "$CONTAINER_NAME"
              echo "✅ 기존 컨테이너가 성공적으로 삭제되었습니다."
            else
              echo "ℹ️ 새로 배포할 컨테이너와 이름이 같은 기존 컨테이너가 없습니다."
            fi

            # ============================================================
            # 호스트 디렉토리 준비
            # ============================================================
            echo "📂 컨테이너에 연결할 호스트 디렉토리를 준비합니다..."
            mkdir -p "$HOST_MOUNT_PATH"

            # ============================================================
            # 새 컨테이너 실행
            # ============================================================
            echo "🚀 새로운 애플리케이션 컨테이너를 실행합니다..."
            docker run -d \
              -p "${PORT}:8000" \
              --name "$CONTAINER_NAME" \
              $ENV_FILE_OPTION \
              -e TZ=Asia/Seoul \
              -v /etc/localtime:/etc/localtime:ro \
              -v "${HOST_MOUNT_PATH}:${CONTAINER_MOUNT_PATH}" \
              "${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:${BRANCH}"

            # ============================================================
            # 사용하지 않는 Docker 이미지 정리 (선택 사항)
            # ============================================================
            echo "🧹 사용하지 않는 Docker 이미지를 정리합니다..."
            docker image prune -f

            # ============================================================
            # 배포 완료 확인
            # ============================================================
            echo "🥂 배포가 성공적으로 완료되었습니다."
            echo "   - 실행된 컨테이너: 📦 $CONTAINER_NAME"
